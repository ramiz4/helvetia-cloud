services:
  # ⚠️ DATABASE MIGRATIONS
  # Before starting services, ensure database migrations are applied:
  # 1. Start postgres: docker-compose up -d postgres
  # 2. Run migrations: pnpm migrate:deploy
  # 3. Start all services: docker-compose up -d
  # See DATABASE_MIGRATIONS.md for detailed migration workflow

  # Docker Socket Proxy - Security layer for Docker API access
  # This service provides a secure proxy to the Docker socket with ACL-based restrictions
  # See DOCKER_SECURITY_HARDENING.md for details
  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: docker-socket-proxy
    restart: unless-stopped
    privileged: true # Required to access Docker socket
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro # Read-only mount for security
    environment:
      # Allow only required operations
      CONTAINERS: 1 # List, inspect containers (required for Traefik and Worker)
      POST: 1 # Create containers/exec (required for Worker)
      BUILD: 1 # Build images (required for Worker)
      COMMIT: 1 # Commit containers (required for Worker)
      IMAGES: 1 # List, inspect images (required for Worker)
      NETWORKS: 1 # Manage networks (required for Traefik)
      VOLUMES: 1 # Manage volumes (for data persistence)
      EXEC: 1 # Execute commands in containers (required for Worker)
      ALLOW_START: 1 # Allow starting containers (required for Worker)
      ALLOW_STOP: 1 # Allow stopping containers (required for Worker)
      ALLOW_RESTARTS: 1 # Allow restart policy configuration (required for Worker)

      # Deny dangerous operations
      SERVICES: 0 # Disable Docker Swarm services
      TASKS: 0 # Disable Docker Swarm tasks
      SWARM: 0 # Disable Swarm management
      INFO: 1 # Allow Docker info (useful for debugging)
      VERSION: 1 # Allow Docker version (useful for debugging)
      PING: 1 # Allow Docker ping (health checks)
    networks:
      - helvetia-net
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://localhost:2375/version']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Reverse Proxy
  traefik:
    image: traefik:v2.11
    command:
      - '--api.insecure=true'
      - '--providers.docker=true'
      - '--providers.docker.exposedbydefault=false'
      - '--log.level=DEBUG'
      - '--entrypoints.web.address=:80'
      - '--providers.docker.endpoint=tcp://docker-socket-proxy:2375' # Use socket proxy
    ports:
      - '80:80'
      - '8090:8080'
    networks:
      - helvetia-net
    depends_on:
      docker-socket-proxy:
        condition: service_healthy

  # Database
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: helvetia
      POSTGRES_PASSWORD: password
      POSTGRES_DB: helvetia
    ports:
      - '5444:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - helvetia-net

  # Queue
  redis:
    image: redis:7-alpine
    ports:
      - '6379:6379'
    networks:
      - helvetia-net

  # Dashboard Service (Placeholder for now)
  # dashboard:
  #   build:
  #     context: .
  #     dockerfile: apps/dashboard/Dockerfile
  #   environment:
  #     NEXT_PUBLIC_API_URL: http://localhost:3001
  #     NEXT_PUBLIC_WS_URL: ws://localhost:3001
  #     NEXT_PUBLIC_APP_URL: http://localhost:3000
  #   ports:
  #     - '3000:3000'
  #   networks:
  #     - helvetia-net

  # Admin Panel Service (Placeholder for now)
  # admin:
  #   build:
  #     context: .
  #     dockerfile: apps/admin/Dockerfile
  #   environment:
  #     NEXT_PUBLIC_API_URL: http://localhost:3001
  #     NEXT_PUBLIC_WS_URL: ws://localhost:3001
  #     NEXT_PUBLIC_APP_URL: http://localhost:3002
  #   ports:
  #     - '3002:3002'
  #   networks:
  #     - helvetia-net

  # API Service (Placeholder for now)
  # api:
  #   build:
  #     context: ./apps/api
  #     dockerfile: Dockerfile.dev
  #   volumes:
  #     - ./apps/api:/app
  #     - /app/node_modules
  #   environment:
  #     DATABASE_URL: postgresql://helvetia:password@postgres:5432/helvetia?schema=public
  #     REDIS_URL: redis://redis:6379
  #     GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID}
  #     GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET}
  #   depends_on:
  #     - postgres
  #     - redis
  #   networks:
  #     - helvetia-net

  # Worker Service (Placeholder for now)
  # worker:
  #   build:
  #     context: ./apps/worker
  #     dockerfile: Dockerfile.dev
  #   volumes:
  #     - ./apps/worker:/app
  #     - /app/node_modules
  #   environment:
  #     REDIS_URL: redis://redis:6379
  #     DATABASE_URL: postgresql://helvetia:password@postgres:5432/helvetia?schema=public
  #     DOCKER_HOST: tcp://docker-socket-proxy:2375 # Use socket proxy instead of direct socket
  #   depends_on:
  #     - redis
  #     - docker-socket-proxy
  #   networks:
  #     - helvetia-net

  # Monitoring Stack: Logs (Loki + Promtail)
  loki:
    image: grafana/loki:2.9.4
    ports:
      - '3100:3100'
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - helvetia-net

  promtail:
    image: grafana/promtail:2.9.4
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - ./monitoring/promtail-config.yml:/etc/promtail/config.yml
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki
    networks:
      - helvetia-net

  # Monitoring Stack: Metrics (Prometheus)
  prometheus:
    image: prom/prometheus:v2.49.1
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - '9090:9090'
    networks:
      - helvetia-net

  # Visualization (Grafana)
  grafana:
    image: grafana/grafana:10.3.3
    ports:
      - '3010:3000'
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning
      - ./grafana-dashboard.json:/var/lib/grafana/dashboards/helvetia.json
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_LOG_LEVEL=debug
    depends_on:
      - prometheus
      - loki
    networks:
      - helvetia-net

networks:
  helvetia-net:
    name: helvetia-net

volumes:
  postgres_data:
  prometheus_data:
  grafana_data:
